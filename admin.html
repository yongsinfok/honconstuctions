<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背景图片管理器 - HON Construction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .hidden-content {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Password Overlay -->
    <div id="auth-overlay" class="fixed inset-0 bg-dark z-[100] flex items-center justify-center bg-slate-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h1 class="text-xl font-bold mb-4 text-gray-800 text-center">管理员验证</h1>
            <p class="text-gray-600 text-sm mb-6 text-center">请输入管理密码以继续</p>
            <input type="password" id="admin-password"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mb-4"
                placeholder="Password">
            <button id="login-btn"
                class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">验证登录</button>
            <p id="auth-error" class="text-red-500 text-xs mt-3 text-center hidden">密码错误，请重试</p>
            <div class="mt-6 text-center">
                <a href="index.html" class="text-gray-400 text-sm hover:underline">返回主页</a>
            </div>
        </div>
    </div>

    <!-- Main Content (Hidden by default) -->
    <div id="main-content" class="hidden-content p-8">
        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">背景图片管理</h1>
                <button onclick="logout()" class="text-xs text-red-500 hover:underline">退出登录</button>
            </div>

            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">当前背景 (Current Image)</h2>
                <div id="current-preview"
                    class="w-full h-48 bg-gray-200 rounded-lg overflow-hidden border border-gray-300">
                    <img id="preview-img" src="" class="w-full h-full object-cover hidden" alt="Current Background">
                    <div id="no-img" class="flex items-center justify-center h-full text-gray-500">正在加载...</div>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-700">更新背景 (Update Image)</h2>
                <input type="file" id="image-input" accept="image/*"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <p class="text-xs text-gray-500">建议尺寸: 1920x1080 (横屏), 文件大小不超过 5MB。</p>

                <button id="upload-btn"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    上传并更新背景 (Upload & Update)
                </button>
                <div id="status" class="mt-4 text-center text-sm font-medium"></div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-gray-800">项目专案管理 (Project Management)</h2>
                <div class="flex justify-between items-center mb-4">
                    <p class="text-sm text-gray-600">管理首页显示的专案列表（数据存储在 Supabase）</p>
                    <button onclick="openProjectModal()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition-colors">+
                        新增项目</button>
                </div>

                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">编号</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">项目名称</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">状态</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody id="projects-list" class="bg-white divide-y divide-gray-200">
                            <!-- Projects will be loaded here -->
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">正在加载项目数据...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex gap-4">
                    <button id="save-projects-btn" onclick="saveAllProjects()" disabled
                        class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">
                        保存所有更改 (Save All Changes)
                    </button>
                    <button id="init-projects-btn" onclick="initializeProjects()"
                        class="px-4 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                        同步/初始化数据
                    </button>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <a href="index.html" class="text-blue-600 hover:underline">← 返回主页 (Back to Sitemap)</a>
            </div>
        </div>
    </div>

    <!-- Project Edit Modal -->
    <div id="project-modal" class="fixed inset-0 bg-black/50 hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">编辑项目</h3>
                <button onclick="closeProjectModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-index">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">项目名称 (Project Title)</label>
                    <input type="text" id="edit-title"
                        class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">客户 (Client)</label>
                    <input type="text" id="edit-client"
                        class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">合同金额 (Value, e.g. RM1.5M)</label>
                        <input type="text" id="edit-value"
                            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">状态 (Status)</label>
                        <select id="edit-status"
                            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="In Progress">进行中 (In Progress)</option>
                            <option value="Complete">已完工 (Complete)</option>
                            <option value="Developer On-hold">暂停 (On-hold)</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">开始日期 (YYYY-MM-DD)</label>
                        <input type="date" id="edit-start"
                            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">结束日期 (YYYY-MM-DD)</label>
                        <input type="date" id="edit-end"
                            class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">备注/工程详情 (Notes)</label>
                    <textarea id="edit-notes" rows="3"
                        class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
                <button onclick="closeProjectModal()"
                    class="px-6 py-2 border border-gray-300 rounded-lg font-bold text-gray-600 hover:bg-gray-50">取消</button>
                <button onclick="applyProjectEdit()"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">确定</button>
            </div>
        </div>
    </div>

    <script>
        // --- AUTH LOGIC ---
        const CORRECT_PASSWORD = 'admin123'; // 【提示】您可以在这里修改默认密码
        const authOverlay = document.getElementById('auth-overlay');
        const mainContent = document.getElementById('main-content');
        const passwordInput = document.getElementById('admin-password');
        const loginBtn = document.getElementById('login-btn');
        const authError = document.getElementById('auth-error');

        function checkAuth() {
            if (sessionStorage.getItem('isAuthorized') === 'true') {
                authOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden-content');
                loadCurrentPreview();
                loadProjects(); // Load projects on login
            }
        }

        loginBtn.addEventListener('click', () => {
            if (passwordInput.value === CORRECT_PASSWORD) {
                sessionStorage.setItem('isAuthorized', 'true');
                authError.classList.add('hidden');
                checkAuth();
            } else {
                authError.classList.remove('hidden');
                passwordInput.value = '';
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        function logout() {
            sessionStorage.removeItem('isAuthorized');
            window.location.reload();
        }

        // --- SUPABASE & UPLOAD LOGIC ---
        const SUPABASE_URL = 'https://ozuuodldwrgiahnlfmig.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SUhzQ4jhWngzy1y1YO-MEA_c4zirUT4';
        const BUCKET_NAME = 'content';
        const FILE_NAME = 'hero-bg.jpg';
        const PROJECTS_FILE = 'projects.json';

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const previewImg = document.getElementById('preview-img');
        const noImg = document.getElementById('no-img');
        const statusDiv = document.getElementById('status');
        const uploadBtn = document.getElementById('upload-btn');
        const imageInput = document.getElementById('image-input');

        const projectsList = document.getElementById('projects-list');
        const saveProjectsBtn = document.getElementById('save-projects-btn');
        let projectsData = [];

        function loadCurrentPreview() {
            const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/${FILE_NAME}?t=${new Date().getTime()}`;
            fetch(publicUrl, { method: 'HEAD' }).then(res => {
                if (res.ok) {
                    previewImg.src = publicUrl;
                    previewImg.classList.remove('hidden');
                    noImg.classList.add('hidden');
                } else {
                    noImg.innerText = '暂无自定义背景，将显示默认图片';
                }
            }).catch(() => {
                noImg.innerText = '无法加载当前图片';
            });
        }

        // --- Project Management Functions ---
        async function loadProjects() {
            const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/${PROJECTS_FILE}?t=${new Date().getTime()}`;
            try {
                const res = await fetch(publicUrl);
                if (res.ok) {
                    projectsData = await res.json();
                    renderProjects();
                } else {
                    projectsList.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">尚未初始化项目数据，请点击“同步/初始化数据”。</td></tr>';
                }
            } catch (err) {
                console.error(err);
                projectsList.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">读取项目数据失败。</td></tr>';
            }
        }

        function renderProjects() {
            projectsList.innerHTML = '';
            if (projectsData.length === 0) {
                projectsList.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无项目。</td></tr>';
                return;
            }

            projectsData.forEach((p, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${p.No}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${p.Project_Title}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${p.Status === 'Complete' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">
                            ${p.Status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right text-sm font-medium">
                        <button onclick="openProjectModal(${index})" class="text-blue-600 hover:text-blue-900 mr-3">编辑</button>
                        <button onclick="deleteProject(${index})" class="text-red-600 hover:text-red-900">删除</button>
                    </td>
                `;
                projectsList.appendChild(tr);
            });
            saveProjectsBtn.disabled = false;
        }

        const modal = document.getElementById('project-modal');
        function openProjectModal(index = null) {
            modal.classList.remove('hidden');
            if (index !== null) {
                const p = projectsData[index];
                document.getElementById('edit-index').value = index;
                document.getElementById('edit-title').value = p.Project_Title;
                document.getElementById('edit-client').value = p.Client;
                document.getElementById('edit-value').value = p.Contract_Value;
                document.getElementById('edit-status').value = p.Status;
                document.getElementById('edit-start').value = p.start_date_iso || '';
                document.getElementById('edit-end').value = p.end_date_iso || '';
                document.getElementById('edit-notes').value = p.Notes || '';
                document.getElementById('modal-title').innerText = '编辑项目';
            } else {
                document.getElementById('edit-index').value = '';
                document.getElementById('edit-title').value = '';
                document.getElementById('edit-client').value = '';
                document.getElementById('edit-value').value = '';
                document.getElementById('edit-status').value = 'In Progress';
                document.getElementById('edit-start').value = '';
                document.getElementById('edit-end').value = '';
                document.getElementById('edit-notes').value = '';
                document.getElementById('modal-title').innerText = '新增项目';
            }
        }

        function closeProjectModal() {
            modal.classList.add('hidden');
        }

        function applyProjectEdit() {
            const index = document.getElementById('edit-index').value;
            const project = {
                No: index === '' ? (projectsData.length > 0 ? Math.max(...projectsData.map(p => p.No)) + 1 : 1) : projectsData[index].No,
                Project_Title: document.getElementById('edit-title').value,
                Client: document.getElementById('edit-client').value,
                Contract_Value: document.getElementById('edit-value').value,
                Status: document.getElementById('edit-status').value,
                start_date_iso: document.getElementById('edit-start').value || null,
                end_date_iso: document.getElementById('edit-end').value || null,
                Notes: document.getElementById('edit-notes').value || null,
                contract_value_num: 0, // Placeholder
                is_pe_capacity: document.getElementById('edit-value').value.includes('PE')
            };

            if (index === '') {
                projectsData.push(project);
            } else {
                projectsData[index] = project;
            }

            renderProjects();
            closeProjectModal();
        }

        function deleteProject(index) {
            if (confirm('确定要删除这个项目吗？')) {
                projectsData.splice(index, 1);
                renderProjects();
            }
        }

        async function saveAllProjects() {
            saveProjectsBtn.disabled = true;
            saveProjectsBtn.innerText = '正在保存...';

            try {
                // Masquerade as image/jpeg because the bucket seems to only allow images
                const blob = new Blob([JSON.stringify(projectsData, null, 2)], { type: 'image/jpeg' });
                const file = new File([blob], PROJECTS_FILE, { type: 'image/jpeg' });

                const { data, error } = await client.storage
                    .from(BUCKET_NAME)
                    .upload(PROJECTS_FILE, file, {
                        upsert: true,
                        contentType: 'image/jpeg'
                    });

                if (error) throw error;
                alert('项目数据保存成功！');
            } catch (err) {
                console.error(err);
                alert('保存失败: ' + err.message);
            } finally {
                saveProjectsBtn.disabled = false;
                saveProjectsBtn.innerText = '保存所有更改 (Save All Changes)';
            }
        }

        // Initial data embedded to avoid "Failed to fetch" when running via file://
        const INITIAL_PROJECTS_DATA = [
            { "No": 1, "Project_Title": "FASA 2 (Lot 169) - Multiple Housing Units (Fasa 2A/2B)", "Client": "Cosmo Property Management Sdn. Bhd.", "Contract_Value": "RM6,667,000.00", "Status": "In Progress", "start_date_iso": "2025-01-01", "end_date_iso": "2026-02-28", "Notes": "Internal & external plumbing, water reticulation, sewerage", "contract_value_num": 6667000.0, "is_pe_capacity": false },
            { "No": 2, "Project_Title": "Pemasangan Air: 2 blocks factory & office (Plot 1), Pekan Bukit Selambau", "Client": "Lagenda Setiamas Sdn. Bhd.", "Contract_Value": "RM1,500,000.00", "Status": "In Progress", "start_date_iso": "2025-08-01", "end_date_iso": "2026-07-30", "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 1500000.0, "is_pe_capacity": false },
            { "No": 3, "Project_Title": "Mixed development: shops & single-storey terraces (plots 60710-60741)", "Client": "MCL Holdings Sdn. Bhd.", "Contract_Value": "RM1,110,180.00", "Status": "In Progress", "start_date_iso": "2025-01-01", "end_date_iso": "2026-03-30", "Notes": "External plumbing, water reticulation & sewerage", "contract_value_num": 1110180.0, "is_pe_capacity": false },
            { "No": 4, "Project_Title": "Factory + Office (Lot PT 98613) - Icon Packaging (HHC Building Construction)", "Client": "HHC Building Construction Sdn. Bhd. (for Icon Packaging)", "Contract_Value": "RM862,705.00", "Status": "In Progress", "start_date_iso": "2025-01-01", "end_date_iso": "2025-12-30", "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 862705.0, "is_pe_capacity": false },
            { "No": 5, "Project_Title": "Training Centre (Phase 1) facilities & utilities", "Client": "Geowood Construction Sdn. Bhd.", "Contract_Value": "RM711,076.00", "Status": "In Progress", "start_date_iso": "2025-01-01", "end_date_iso": "2026-02-01", "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 711076.0, "is_pe_capacity": false },
            { "No": 6, "Project_Title": "Water installation for 2 blocks factory + offices (Plot 1), Bukit Selambau", "Client": "Far East Agenda Sdn. Bhd.", "Contract_Value": "RM468,000.00", "Status": "In Progress", "start_date_iso": "2025-01-01", "end_date_iso": "2026-03-30", "Notes": "CWSP internal & external plumbing, water reticulation & sewerage", "contract_value_num": 468000.0, "is_pe_capacity": false },
            { "No": 7, "Project_Title": "Residential development (18 units + single/double-storey houses), Sungai Petani", "Client": "Jubli Harmony", "Contract_Value": "RM140,000.00", "Status": "In Progress", "start_date_iso": "2025-06-01", "end_date_iso": "2026-03-30", "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 140000.0, "is_pe_capacity": false },
            { "No": 8, "Project_Title": "1-unit factory + 2-storey office - Icon Packaging", "Client": "Icon Packaging Sdn. Bhd.", "Contract_Value": "RM951,805.00", "Status": "In Progress", "start_date_iso": "2025-01-01", "end_date_iso": "2025-11-30", "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 951805.0, "is_pe_capacity": false },
            { "No": 9, "Project_Title": "Factory & office development (Pekan Bukit Selambau) — Gaomart", "Client": "Tetuan Gaomart (M) Sdn Bhd", "Contract_Value": "RM280,000.00", "Status": "In Progress", "start_date_iso": "2025-07-01", "end_date_iso": "2026-07-30", "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 280000.0, "is_pe_capacity": false },
            { "No": 10, "Project_Title": "Open factory for charcoal processing + office & parking", "Client": "Best Carbon Chemical Sdn. Bhd.", "Contract_Value": "RM245,000.00", "Status": "Developer On-hold", "start_date_iso": null, "end_date_iso": null, "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 245000.0, "is_pe_capacity": false },
            { "No": 11, "Project_Title": "Amendment to approved plan — Factory & office (Lot 86)", "Client": "Yetta Steel Industries Sdn Bhd", "Contract_Value": "RM244,000.00", "Status": "In Progress", "start_date_iso": "2025-11-15", "end_date_iso": "2026-06-30", "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 244000.0, "is_pe_capacity": false },
            { "No": 12, "Project_Title": "Large mixed residential development (Bandar Lunas) — multiple housing types", "Client": "Sri Pengkalan Binaan Sdn. Bhd.", "Contract_Value": "RM1,440,000.00", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": "Internal & external plumbing, water reticulation & sewerage", "contract_value_num": 1440000.0, "is_pe_capacity": false },
            { "No": 13, "Project_Title": "Addition of single-storey factory (plastic processing) — External sewerage & reticulation", "Client": "Respack Polychem Sdn. Bhd.", "Contract_Value": "RM300,900.00", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 300900.0, "is_pe_capacity": false },
            { "No": 14, "Project_Title": "132kV Main Substation Buildings & Electrical Structures (Solar PV project)", "Client": "BGMCBRAS Power Sdn. Bhd.", "Contract_Value": "RM1,484,238.00", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": "Includes buildings for solar PV substation", "contract_value_num": 1484238.0, "is_pe_capacity": false },
            { "No": 15, "Project_Title": "3 Blocks factory + offices + facilities (Bukit Selambau)", "Client": "Genting Ehsan (SP) Sdn. Bhd.", "Contract_Value": "RM1,130,000.00", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 1130000.0, "is_pe_capacity": false },
            { "No": 16, "Project_Title": "95-unit apartment plumbing works (Alor Setar)", "Client": "Imperio Development Sdn. Bhd.", "Contract_Value": "RM1,030,000.00", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": "Internal cold water & sanitary plumbing services", "contract_value_num": 1030000.0, "is_pe_capacity": false },
            { "No": 17, "Project_Title": "Residential development — semi-detached & terrace houses (Bayan Hill)", "Client": "Paramount Property Construction Sdn. Bhd.", "Contract_Value": "RM2,800,000.00", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 2800000.0, "is_pe_capacity": false },
            { "No": 20, "Project_Title": "Sewage treatment plant (Bandar Jitra)", "Client": "MKMutiara Sdn. Bhd.", "Contract_Value": "(4990 PE)", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": "Sewage treatment plant capacity noted", "contract_value_num": 0, "is_pe_capacity": true },
            { "No": 21, "Project_Title": "Upgrade sewage treatment plant (Bandar Bedong)", "Client": "OIB Properties (KV) Sdn. Bhd.", "Contract_Value": "(2770 PE)", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 0, "is_pe_capacity": true },
            { "No": 22, "Project_Title": "Wastewater pumping station for Seri Temin housing scheme", "Client": "Jesin Development (Bukit Kayu Hitam) Sdn Bhd", "Contract_Value": "(2015 PE)", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 0, "is_pe_capacity": true },
            { "No": 23, "Project_Title": "Sewage treatment plant for mixed development (Sungai Lalang)", "Client": "Hongjin Construction Sdn Bhd", "Contract_Value": "(2192 PE)", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 0, "is_pe_capacity": true },
            { "No": 24, "Project_Title": "Sewage treatment plant for 6-block apartment (1200 units) - Alor Setar", "Client": "Harta Sentosa Sdn Bhd", "Contract_Value": "(6200 PE)", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 0, "is_pe_capacity": true },
            { "No": 25, "Project_Title": "Upgrade treatment plant for hotel conversion works (Jelutong)", "Client": "GMHotel Sdn Bhd", "Contract_Value": "(3110 PE)", "Status": "Complete", "start_date_iso": null, "end_date_iso": null, "Notes": null, "contract_value_num": 0, "is_pe_capacity": true }
        ];

        async function initializeProjects() {
            if (!confirm('这将从本地 embedded 模板读取初始数据并覆盖 Supabase 中的数据，确定吗？')) return;
            try {
                // Use embedded data directly to avoid fetch() failure on file:// protocols
                projectsData = JSON.parse(JSON.stringify(INITIAL_PROJECTS_DATA));
                renderProjects();
                alert('已从模板同步，请记得点击“保存所有更改”提交到云端。');
            } catch (err) {
                alert('同步失败: ' + err.message);
            }
        }

        uploadBtn.addEventListener('click', async () => {
            const file = imageInput.files[0];
            if (!file) {
                alert('请先选择一个文件 (Please select a file)');
                return;
            }

            uploadBtn.disabled = true;
            statusDiv.innerText = '正在上传... (Uploading...)';
            statusDiv.className = 'mt-4 text-center text-sm font-medium text-blue-600';

            try {
                const { data, error } = await client.storage
                    .from(BUCKET_NAME)
                    .upload(FILE_NAME, file, {
                        upsert: true,
                        contentType: 'image/jpeg'
                    });

                if (error) throw error;

                statusDiv.innerText = '上传成功！请刷新主页查看。(Success! Refresh home to view.)';
                statusDiv.className = 'mt-4 text-center text-sm font-medium text-green-600';
                loadCurrentPreview();
                imageInput.value = '';
            } catch (err) {
                console.error(err);
                statusDiv.innerText = '上传失败: ' + err.message;
                statusDiv.className = 'mt-4 text-center text-sm font-medium text-red-600';
            } finally {
                uploadBtn.disabled = false;
            }
        });

        // Initialize
        checkAuth();
    </script>
</body>

</html>